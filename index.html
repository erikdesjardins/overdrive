<html>
<head></head>
<body>
<input type="file"></input><span id="playing"></span>
<div><input id="bypass" type="range" min="0" max="100" value="0"/>Bypass</div>
<div><input id="color" type="range" min="0" max="22050" value="800"/>Color</div>
<div><input id="preband" type="range" min="0" max="100" value="50"/>Preband (dry/wet)</div>
<div><input id="drive" type="range" min="0" max="100" value="50"/>Drive</div>
<div><input id="postcut" type="range" min="0" max="22050" value="3000"/>Postcut (lowpass)</div>
<script>
class Overdrive {
	constructor(context) {
		this.input = context.createGain();
		this.output = context.createGain();

		// Internal AudioNodes
		this._bypassAround = context.createGain();
		this._bypassThrough = context.createGain();
		this._bandpass = context.createBiquadFilter();
		this._bpWet = context.createGain();
		this._bpDry = context.createGain();
		this._ws = context.createWaveShaper();
		this._lowpass = context.createBiquadFilter();

		// AudioNode graph routing
		this.input.connect(this._bypassAround);
		this.input.connect(this._bypassThrough);
		this._bypassThrough.connect(this._bandpass);
		this._bandpass.connect(this._bpWet);
		this._bandpass.connect(this._bpDry);
		this._bpWet.connect(this._ws);
		this._ws.connect(this._lowpass);
		this._lowpass.connect(this.output);
		this._bpDry.connect(this.output);
		this._bypassAround.connect(this.output);

		// Defaults
		this.bypass = 0;
		this.color = 800;
		this.preBand = 0.5;
		this.drive = 0.5;
		this.postCut = 3000;
	}

	get bypass() { return this._bypassAround.gain.value; }
	set bypass(value) {
		this._bypassAround.gain.setValueAtTime(value, 0);
		this._bypassThrough.gain.setValueAtTime(1 - value, 0);
	}

	get color() { return this._bandpass.frequency.value; }
	set color(value) {
		this._bandpass.frequency.setValueAtTime(value, 0);
	}

	get preBand() { return this._bpWet.gain.value; }
	set preBand(value) {
		this._bpWet.gain.setValueAtTime(value, 0);
		this._bpDry.gain.setValueAtTime(1 - value, 0);
	}

	get drive() { return this._drive; }
	set drive(value) {
		const k = value * 100;
		const n = 22050;
		const curve = new Float32Array(n);
		const deg = Math.PI / 180;

		this._drive = value;
		for (let i = 0; i < n; i++) {
			const x = i * 2 / n - 1;
			curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
		}
		this._ws.curve = curve;
	}

	get postCut() { return this._lowpass.frequency.value; }
	set postCut(value) {
		this._lowpass.frequency.setValueAtTime(value, 0);
	}
}

let overdrive, source;

document.getElementById('bypass').addEventListener('input', e => overdrive.bypass = +e.target.value / 100);
document.getElementById('color').addEventListener('input', e => overdrive.color = +e.target.value);
document.getElementById('preband').addEventListener('input', e => overdrive.preBand = +e.target.value / 100);
document.getElementById('drive').addEventListener('input', e => overdrive.drive = +e.target.value / 100);
document.getElementById('postcut').addEventListener('input', e => overdrive.postCut = +e.target.value);

document.querySelector('input').addEventListener('change', e => {
	const context = new AudioContext();
	overdrive = new Overdrive(context);

	const file = e.target.files[0];
	if (!file) return;
	const reader = new FileReader();
	reader.onload = () => {
		context.decodeAudioData(reader.result, audioBuffer => {
			if (source) source.stop(0);

			document.getElementById('playing').textContent = file.name;
			document.querySelector('input').value = null;

			source = context.createBufferSource();
			source.buffer = audioBuffer;
			source.connect(overdrive.input);
			overdrive.output.connect(context.destination);
			source.start(0);
		});
	}
	reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
